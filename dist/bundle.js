!function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class n{constructor(){this.events=new Map}on(t,e){this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(e)}off(t,e){if(this.events.has(t)){const i=this.events.get(t);i.has(e)&&i.delete(e)}}emit(t,e){this.events.has(t)&&this.events.get(t).forEach(t=>{t(e)})}}function s(t,e=null,i=null){const n=document.createElement(t);return e&&h(n,e),i&&r(n,i),n}function a(t,e=null,i=null){const n=document.createElementNS("http://www.w3.org/2000/svg",t);return e&&h(n,e),i&&r(n,i),n}function h(t,e){Object.keys(e).forEach(i=>{switch(i){case"classes":e[i].forEach(e=>t.classList.add(e));break;case"textContent":t.textContent=e[i];break;case"selected":t.selected=e[i];default:t.setAttribute(i,e[i])}})}function r(t,e){e.forEach(e=>t.appendChild(e))}class o{constructor({parent:t,title:e,content:i}){this.title=e,this.content=i,this.node=null,this.parent=t,this.render()}render(){this.node=s("div",{id:"description"},[s("h1",{textContent:this.title},null)]),this.content.forEach(t=>{const e=s("p",{textContent:t},null);this.node.appendChild(e)}),this.parent.node.appendChild(this.node)}}class d{constructor({parent:t,prop:e,label:i,options:n,value:s}){this.prop=e,this.label=i,this.options=n,this.value=s,this.parent=t,this.node=null,this.input=null,this.render(),this.eventListener()}render(){const t=this.options.map(t=>s("option",{value:t,textContent:t,selected:t===this.value}));this.input=s("select",{id:this.prop},t),this.node=s("div",{classes:["select"]},[s("label",{textContent:this.label,for:this.prop},null),s("br"),this.input]),this.parent.node.appendChild(this.node)}eventListener(){this.input.addEventListener("change",this.eventHandler.bind(this))}eventHandler(t){this.value=this.input.value,this.parent.event.emit(this.prop,{prop:this.prop,value:this.value})}}class l{constructor({parent:t,label:e,prop:i,type:n="image"}){this.prop=i,this.type=n,this.label=e,this.parent=t,this.node=null,this.input=null,this.render(),this.eventListener()}render(){this.input=s("input",{type:"file",id:this.prop},null),this.node=s("label",{textContent:this.label,classes:["file-btn"]},[this.input]),this.parent.node.appendChild(this.node)}eventListener(){this.input.addEventListener("change",this.eventHandler.bind(this))}eventHandler(t){const e=new FileReader;e.onload=(t=>{const e="json"===this.type?JSON.parse(t.target.result):t.target.result,i=this.prop?{[this.prop]:e}:e;this.parent.event.emit(this.prop,{prop:this.prop,value:i})}),"image"===this.type&&e.readAsDataURL(t.target.files[0]),"json"===this.type&&e.readAsText(t.target.files[0])}}class p{constructor({parent:t,label:e,prop:i}){this.prop=i,this.label=e,this.parent=t,this.node=null,this.render(),this.eventListener()}render(){this.node=s("button",{textContent:this.label},null),this.parent.node.appendChild(this.node)}eventListener(){this.node.addEventListener("click",this.eventHandler.bind(this))}eventHandler(t){this.parent.event.emit(this.prop)}}class c{constructor({parent:t,max:e,min:i,step:n=1,value:s,prop:a,label:h}){this.prop=a,this.label=h,this.max=e,this.min=i,this.step=n,this.value=s,this.parent=t,this.node=null,this.input=null,this.output=null,this.render(),this.eventListener()}render(){this.input=s("input",{type:"range",id:this.prop,max:this.max,min:this.min,step:this.step,value:this.value}),this.output=s("output",{textContent:this.value}),this.node=s("div",{classes:["slider"]},[s("label",{for:this.prop,textContent:`${this.label} â€” `}),this.output,s("br"),this.input]),this.parent.node.appendChild(this.node)}eventListener(){this.input.addEventListener("change",this.eventHandler.bind(this))}eventHandler(t){const e=this.input.valueAsNumber;this.output.textContent=e,this.parent.event.emit(this.prop,{prop:this.prop,value:e})}}class u{constructor({parent:t,prop:e,value:i,label:n}){this.prop=e,this.label=n,this.value=i,this.node=null,this.parent=t,this.render(),this.eventListener()}render(){this.node=s("button",{textContent:this.label,id:this.prop,classes:["toggle"]},null),this.value||this.node.classList.add("deactivated"),this.parent.node.appendChild(this.node)}eventListener(){this.node.addEventListener("click",this.eventHandler.bind(this))}eventHandler(t){this.node.classList.toggle("deactivated"),this.value=!this.value,this.parent.event.emit(this.prop,{prop:this.prop,value:this.value})}}class g{constructor({parent:t,select:e,emptyMessage:i="No options"}){this.emptyMessage=i,this.select=e.input,this.selectValue=this.select.value,this.parent=t,this.event=this.parent.event,this.node=null,this.groups={},this.render(),this.eventListener()}createGroup({name:t,nodes:e}){const i=s("div",{id:`section-${t}`},e.map(t=>t.node));this.groups[t]=i,this.render()}render(){this.groups[this.selectValue]||(this.groups[this.selectValue]=s("div",{classes:["section-empty"]},[s("p",{textContent:this.emptyMessage})])),this.node?this.node.replaceChild(this.groups[this.selectValue],this.node.firstElementChild):(this.node=s("div",{classes:["section-container"]},[this.groups[this.selectValue]]),this.parent.node.appendChild(this.node))}eventListener(){this.select.addEventListener("change",this.eventHandler.bind(this))}eventHandler(t){this.selectValue=this.select.value,this.render()}}class m{constructor({event:t,showOnLoad:e=!0}){this.showOnLoad=e,this.event=t,this.componentTypes={description:o,select:d,toggleButton:u,slider:c,fileButton:l,downloadButton:p,section:g},this.node=null,this.menuBtn=null,this.closeBtn=null,this.reset(),this.render(),this.eventListener()}reset(){const t=document.querySelector("#ui"),e=document.querySelector("#menu");t&&t.parentNode.removeChild(t),e&&e.parentNode.removeChild(e)}createComponent(t,e=null){return e.parent||(e=Object.assign({},{parent:this},e)),new this.componentTypes[t](e)}render(){this.menuBtn=a("svg",{width:45,height:45,id:"menu"},[a("rect",{x:10,y:10,width:25,height:5,fill:"#000"}),a("rect",{x:10,y:20,width:25,height:5,fill:"#000"}),a("rect",{x:10,y:30,width:25,height:5,fill:"#000"})]),this.closeBtn=s("button",{textContent:"[ close ]",id:"close"},null),this.node=s("div",{id:"ui"},[this.closeBtn]),this.showOnLoad||this.node.classList.add("moverIzq"),document.body.appendChild(this.menuBtn),document.body.appendChild(this.node)}addSeparator(){const t=document.createElement("hr");this.node.appendChild(t)}eventListener(){this.menuBtn.addEventListener("click",this.openEventHandler.bind(this)),this.closeBtn.addEventListener("click",this.closeEventHandler.bind(this))}openEventHandler(t){this.node.classList.remove("moverIzq")}closeEventHandler(t){this.node.classList.add("moverIzq")}addSignature(){const t=a("svg",{width:50,height:50,viewBox:"0 0 13.229166 13.229167"},[a("rect",{y:"-7.7716e-16",width:"13.229",height:"13.229",fill:"#aaa",style:"paint-order:normal"},null),a("g",{fill:"#fff"},[a("path",{d:"m5.7496 1.641v6.8601c0 0.75774-0.61427 1.372-1.372 1.372-0.63771 0-1.174-0.43495-1.3278-1.0245l-1.2898 1.2898c0.54581 0.87079 1.514 1.4497 2.6176 1.4497 1.7049 0 3.087-1.3821 3.087-3.0871v-6.8601z"},null),a("path",{d:"m8.3907 5.4141v6.1741c1.701-5e-3 3.0785-1.385 3.0785-3.0871 0-1.7021-1.3775-3.0824-3.0785-3.087z"},null),a("path",{d:"m8.3907 1.641v3.43c0.94414-4e-3 1.7084-0.77004 1.7084-1.715s-0.76428-1.7115-1.7084-1.715z"},null)])]),e=s("a",{href:"https://github.com/jblanper",target:"_blank",id:"signature"},[s("span",{textContent:"by"}),t]);this.node.appendChild(e)}}class v{constructor({event:t,url:e,drawingCtx:i,width:n=null,blackAndWhite:s=!1}){this.url=e,this.width=n,this.height=void 0,this.maxWidth=void 0,this.maxHeight=void 0,this.drawingCtx=i,this.bwCtx=document.createElement("canvas").getContext("2d"),this.colorCtx=document.createElement("canvas").getContext("2d"),this.blackAndWhite=s,this.img,this.event=t,this.event.on("blackAndWhite",this.update.bind(this)),this.event.on("width",this.update.bind(this)),this.event.on("drawingType",t=>{"image"===t.value&&this.draw()})}init(){return this.setImg().then(t=>(console.log(t),this.setCachedImg(),"Created cached image and got its data")).catch(t=>console.log(t))}get ctx(){return this.blackAndWhite?this.bwCtx:this.colorCtx}setImg(){return new Promise((t,e)=>{this.img=new Image,this.img.src=this.url,this.img.onload=(e=>t(`"${this.img.src}" loaded`)),this.img.onerror=(t=>e(`Error loading "${this.img.src}"`))})}setCachedImg(){this.setImgSize(),this.colorCtx.canvas.width=this.width,this.colorCtx.canvas.height=this.height,this.bwCtx.canvas.width=this.width,this.bwCtx.canvas.height=this.height,this.colorCtx.drawImage(this.img,0,0,this.width,this.height),this.bwCtx.putImageData(this.getBwImageData(),0,0)}setImgSize(){const t=this.img.height/this.img.width,e=window.innerHeight/window.innerWidth;this.maxWidth=e<t?window.innerHeight/t:window.innerWidth,this.maxHeight=e<t?window.innerHeight:window.innerWidth*t,this.width&&this.width<=window.innerWidth&&this.width*t<=window.innerHeight?this.height=this.width*t:(this.width=this.maxWidth,this.height=this.maxHeight)}getBwImageData(){const t=this.colorCtx.getImageData(0,0,this.width,this.height);for(let e=0;e<t.data.length;e+=4){const i=.2126*t.data[e]+.7152*t.data[e+1]+.0722*t.data[e+2];t.data[e]=i,t.data[e+1]=i,t.data[e+2]=i}return t}draw(){this.drawingCtx.canvas.width=this.width,this.drawingCtx.canvas.height=this.height,this.drawingCtx.drawImage(this.ctx.canvas,0,0,this.width,this.height)}update(t){this[t.prop]=t.value,this.width!==this.colorCtx.canvas.width&&this.setCachedImg(),this.draw(),this.event.emit("cachedImage-update")}}class w{constructor({event:t,cachedImg:e,drawingCtx:i,quantizeStep:n=3,withDithering:s=!0}){this.withDithering=s,this.quantizeStep=n,this.cachedImg=e,this.imgData=null,this.drawingCtx=i,this.event=t,this.event.on("withDithering",this.update.bind(this)),this.event.on("quantizeStep",this.update.bind(this)),this.event.on("drawingType",t=>{"quantize"===t.value&&this.draw()}),this.event.on("cachedImage-update",this.process.bind(this)),this.process()}get width(){return this.cachedImg.ctx.canvas.width}get height(){return this.cachedImg.ctx.canvas.height}process(){this.imgData=this.cachedImg.ctx.getImageData(0,0,this.width,this.height);for(let t=0;t<this.imgData.data.length;t+=4){const e=this.quantize(this.imgData.data[t]),i=this.quantize(this.imgData.data[t+1]),n=this.quantize(this.imgData.data[t+2]);this.withDithering&&this.fsDithering(e,i,n,t),this.imgData.data[t]=e,this.imgData.data[t+1]=i,this.imgData.data[t+2]=n}}quantize(t){return Math.round(t*this.quantizeStep/255)*Math.floor(255/this.quantizeStep)}fsDithering(t,e,i,n){const s={r:this.imgData.data[n]-t,g:this.imgData.data[n+1]-e,b:this.imgData.data[n+2]-i};this.fsDitheringColorOperation({index:n+4,numerator:7,denominator:16,quantError:s}),this.fsDitheringColorOperation({index:n+4*this.width-4,numerator:3,denominator:16,quantError:s}),this.fsDitheringColorOperation({index:n+4*this.width,numerator:5,denominator:16,quantError:s}),this.fsDitheringColorOperation({index:n+4*this.width+4,numerator:1,denominator:16,quantError:s})}fsDitheringColorOperation({index:t,numerator:e,denominator:i,quantError:n}){this.imgData.data[t]=Math.round(this.imgData.data[t]+n.r*(e/i)),this.imgData.data[t+1]=Math.round(this.imgData.data[t+1]+n.g*(e/i)),this.imgData.data[t+2]=Math.round(this.imgData.data[t+2]+n.b*(e/i))}changeCanvasSize(){this.drawingCtx.canvas.width===this.width&&this.drawingCtx.canvas.height===this.height||(this.drawingCtx.canvas.width=this.width,this.drawingCtx.canvas.height=this.height)}draw(){this.changeCanvasSize(),this.drawingCtx.putImageData(this.imgData,0,0)}update(t){this[t.prop]=t.value,this.process(),this.draw()}}class b{constructor(t){this.drawingCtx=document.querySelector("#sketch").getContext("2d"),this.drawingType=t.drawingType,this.imageOptions=t.image,this.quantizeOptions=t.quantize}init({imageUrl:t=this.imageOptions.url}={}){return this.event=new n,this.cachedImg=new v({event:this.event,url:t,width:this.imageOptions.width,blackAndWhite:this.imageOptions.blackAndWhite,drawingCtx:this.drawingCtx}),this.cachedImg.init().then(t=>(console.log(t),this.imageQuantizer=new w({cachedImg:this.cachedImg,drawingCtx:this.drawingCtx,quantizeStep:this.quantizeOptions.quantizeStep,withDithering:this.quantizeOptions.withDithering,event:this.event}),this.event.emit("drawingType",{prop:"drawingType",value:this.drawingType}),this.event.on("imageUrl",t=>this.init(t.value)),this.event.on("png",this.setPng.bind(this)),function(t,e){const i=new m({event:t,showOnLoad:!0});i.createComponent("description",{title:"Dither me!",content:["Small web app for applying color quantization and dithering to any image. It can also turn any picture black and white and change its size. Please use the button below to upload an image.","Enjoy!"]}),i.addSeparator();const n=i.createComponent("select",{prop:"drawingType",label:"draw options",options:["image","quantize"],value:e.drawingType});i.addSeparator();const s=i.createComponent("section",{select:n,emptyMessage:"No options for this section"}),a=i.createComponent("toggleButton",{parent:s,label:"toggle b&w",prop:"blackAndWhite",value:e.image.blackAndWhite}),h=i.createComponent("slider",{parent:s,max:e.image.maxWidth,min:100,prop:"width",label:"image size in px",value:e.image.width});s.createGroup({name:"image",nodes:[a,h]});const r=i.createComponent("toggleButton",{parent:s,label:"toggle dithering",prop:"withDithering",value:e.quantize.withDithering}),o=i.createComponent("slider",{parent:s,label:"quantize step",max:8,min:1,prop:"quantizeStep",value:e.quantize.quantizeStep});s.createGroup({name:"quantize",nodes:[r,o]}),i.addSeparator(),i.createComponent("fileButton",{prop:"imageUrl",label:"upload IMG"}),i.createComponent("downloadButton",{label:"download IMG",prop:"png"}),i.addSignature()}(this.event,{drawingType:this.drawingType,image:{blackAndWhite:this.imageOptions.blackAndWhite,width:this.cachedImg.width,maxWidth:this.cachedImg.maxWidth},quantize:this.quantizeOptions}),"Sketch initialized"))}setPng(){const t=Object.assign(document.createElement("canvas"),{width:this.drawingCtx.canvas.width,height:this.drawingCtx.canvas.height}).getContext("2d");t.drawImage(this.drawingCtx.canvas,0,0);const e=t.canvas.toDataURL("image/png"),i=document.createElement("a");i.style="display: none;",i.download=e.startsWith("data:image")?"img.png":"img.json",i.href=e,document.body.appendChild(i),i.click(),i.parentNode.removeChild(i)}}new b({sketch:{drawingType:"image",image:{url:"./photo.jpg",width:null,blackAndWhite:!1},quantize:{quantizeStep:1,withDithering:!1}}}.sketch).init().then(t=>console.log(t)).catch(t=>console.log(t))}]);